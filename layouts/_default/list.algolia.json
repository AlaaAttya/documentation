{{- $.Scratch.Add "algoliaindex" slice -}}
{{- $section := $.Site.GetPage "section" .Section -}}

{{- range (where .Site.AllPages "Kind" "!=" "home") -}}
    {{- $page := . -}}
    {{- if and ($page.IsDescendant $section) (eq $page.Language.Lang "en") (ne $page.Params.private true) (ne $page.Params.kind "faq") (ne $page.Params.beta true) (not $page.Draft) (not (isset .Params "external_redirect")) -}}
        {{ $rel_path := (print $page.File.Lang "/" $page.File.Path) }}
        {{ $object_id := md5 $rel_path -}}
        {{ $title := $page.Params.integration_title | default $page.Title }}
        {{ $sectionHeader := "" }}
        {{ $sectionContent := "" }}
        {{ $content := htmlUnescape $page.Plain | truncate 10000 }}
        {{ $tags := slice }}
        {{ $rank := 0 }}

        {{- /* Better way to do this?  Frontmatter (cascading) probably? */ -}}
        {{ if in $page.RelPermalink "/api/latest" }}
            {{ $tags = $tags | append "api_latest" }}
            {{ $rank = 10 }}
        {{ else if in $page.RelPermalink "/guide/" }}
            {{ $tags = $tags | append "guide" }}
            {{ $rank = 20 }}
        {{ else if in $page.RelPermalink "/account_management/rbac/permissions" }}
            {{ $tags = $tags | append "rbac_permissions" }}
            {{ $rank = 60 }}
        {{ else if in $page.RelPermalink "/getting_started/" }}
            {{ $tags = $tags | append "getting_started" }}
            {{ $rank = 70 }}
        {{ else if in $page.RelPermalink "/security_platform/default_rules" }}
            {{ $tags = $tags | append "default_rules" }}
            {{ $rank = 30 }}
        {{ else if in $page.RelPermalink "/integrations/" }}
            {{ $tags = $tags | append "integrations" }}
            {{ $rank = 40 }}
        {{ else }}
            {{ $tags = $tags | append "docs" }}
            {{ $rank = 50 }}
        {{ end }}

        {{ $contentArray := split $page.Content "<h2" }}

        {{ range $contentArray }}
        {{ if in . "h2" }}
            {{ $context := print "%s" . | printf "%s%s" "<h2" }}
            {{ $sectionHeader = index (split (index (split $context "</h2>") 0) ">") 1 }}
            {{ $sectionContent = $context | plainify }}

            {{ if eq $sectionHeader "Further Reading" }}
                {{ $sectionHeader = "" }}
                {{ $sectionContent = "" }}
            {{ end }}

            {{ if ne $sectionHeader "" }}
                {{- /* Each section on a page gets indexed with own "sectionHeader" and  "content" */ -}}
                {{- $.Scratch.Add "algoliaindex" (
                dict "objectID" $object_id 
                "title" $title
                "sectionHeader" $sectionHeader
                "description" $page.Description
                "content" $sectionContent
                "type" $page.Type
                "permalink" $page.Permalink
                "relpermalink" $page.RelPermalink
                "language" $page.Language.Lang
                "tags" $tags
                "rank" $rank
                ) -}}
            {{ end }}
        {{ end }}
        {{ end }}

        {{- /* Each page gets indexed without "sectionHeader" and with truncated "content" */ -}}
        {{- $.Scratch.Add "algoliaindex" (
        dict "objectID" $object_id 
        "title" $title
        "description" $page.Description
        "content" $content
        "type" $page.Type
        "permalink" $page.Permalink
        "relpermalink" $page.RelPermalink
        "language" $page.Language.Lang
        "tags" $tags
        "rank" $rank
        ) -}}

    {{- end -}}
{{- end -}}

{{- /* Outputs final JSON object, copied to public/ folder. */ -}}
{{- $.Scratch.Get "algoliaindex" | jsonify -}}
